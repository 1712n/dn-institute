<nav>
  {{ partial "docs/brand" . }}
  {{ partial "docs/search" . }}
  {{ if .Site.IsMultiLingual }}
    {{ partial "docs/languages" . }}
  {{ end }}

  {{ partial "docs/inject/menu-before" . }}

  <div class="book-tree">
    <!-- list main sections -->
    {{ range site.Home.Pages }}
      <div class="submenu">
        <h2>
          <a href="{{ .RelPermalink }}">{{ .Title }}</a>
        </h2>
        
        <ul>
          <!-- list sub sections -->
          {{ range .Pages }}
            {{ if eq .Kind "section" }}
              <!-- special case: posts -->
              {{ if eq .Type "posts" }}
                <li class="subsection">
                  <h3>
                    <a href="{{ .RelPermalink }}">{{ .Title }}</a>
                  </h3>

                  <ul class="taxonomies">
                    <!-- NOTE: Taxonomies are site-wide and not section-specific. -->
                    {{ range $taxonomy, $terms := site.Taxonomies }}
                      <li>
                        {{ with site.GetPage $taxonomy }}
                          <h4>
                            <a href="{{ .RelPermalink }}">{{ .LinkTitle }}</a>
                          </h4>
                        {{ end }}
                       
                        {{ with $terms }}
                          <ul class="terms">
                            {{ range . }}
                              <li>
                                <a href="{{ .Page.RelPermalink }}">{{ .Page.Title }}</a>
                              </li>
                            {{ end }}
                          </ul>
                        {{ end }}
                      </li>
                    {{ end }}
                  </ul>
                </li>

              <!-- other cases -->
              {{ else }}
                <li class="subsection">
                  <h3>
                    <a href="{{ .RelPermalink }}">{{ .Title }}</a>
                  </h3>

                  {{ with .Pages }}
                    <ul class="pages">
                      {{ range . }}
                        <li>
                          <a href="{{ .RelPermalink }}">{{ .Title }}</a>
                        </li>
                      {{ end }}
                    </ul>
                  {{ end }}
                </li>
              {{ end }}
            {{ end }}
          {{ end }}
        </ul>
      </div>
    {{ end }}

    <div class="submenu external-links">
      <h2>External</h2>
      {{ partial "docs/menu-hugo" .Site.Menus.external }}
    </div>
  </div>
    
  {{ partial "docs/inject/menu-after" . }}
</nav>

<!-- Restore menu position as soon as possible to avoid flickering -->
{{ $script := resources.Get "menu-reset.js" | resources.Minify }}
{{ with $script.Content }}
  <script>{{ . | safeJS }}</script>
{{ end }}
