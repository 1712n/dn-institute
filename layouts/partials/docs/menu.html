{{ define "taxonomies" }}
  {{ $page := .page }}
  {{ $section := .item }}
  {{ $path := .path }}
  {{ $level := add .level 1 }}

  {{ range $taxonomy, $terms := site.Taxonomies }}
    {{ with site.GetPage $taxonomy }}
      {{ if (hasPrefix .RelPermalink $section.RelPermalink) }}
        {{ $showTerms := .Params.navShowTerms | default false }}

        <li class="taxonomy {{ if $showTerms }}collapsible{{ end }}">
        <h{{ $level }}>{{ partial "docs/menu-anchor" (dict "page" $page "item" . "control" $showTerms) }}</h{{ $level }}>

          {{ if $showTerms }}
            {{ with $terms }}
              {{ $name := .LinkTitle | urlize | lower }}
              {{ $path = printf "%s-%s" $path $name }}
              {{ $id := printf "ul%d-%s" $level $path }} 

              <ul class="terms collapsible-target" id="{{ $id }}">
                {{ range . }}
                  <li>{{ partial "docs/menu-anchor" (dict "page" $page "item" .Page) }}</li>
                {{ end }}
              </ul>
            {{ end }}
          {{ end }}
        </li>
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{ define "menu" }}
  {{ $page = .page }}
  {{ $level = .level }}

  {{ range .item.Pages }}
    {{ $name = .LinkTitle | urlize | lower }}
    {{ $path = printf "%s-%s" $path $name }}
    {{ $id = printf "ul%d-%s" $level $path }} 

    <li class="li-h{{ $level }} collapsible">
      {{ $control = (or (.Param "navShowPages") (.Param "navShowTaxonomies")) }}
      <h{{ $level }}>{{ partial "docs/menu-anchor" (dict "page" $page "item" . "control" $control) }}</h{{ $level }}>

      {{ if .Param "navShowTaxonomies" }}
        <ul class="taxonomies collapsible-target" id="{{ $id }}">
          {{ template "taxonomies" (dict "page" $page "item" . "level" $level "path" $path) }}
        </ul>
      {{ end }}

      {{ if .Param "navShowPages" }}
        <ul class="pages collapsible-target" id="{{ $id }}">
          {{ range .Pages }}
            <li>{{ partial "docs/menu-anchor" (dict "page" $page "item" .) }}</li>
          {{ end }}
        </ul>
      {{ end }}
    </li>
  {{ end }}
{{ end }}

<nav>
  {{ partial "docs/brand" . }}
  {{ partial "docs/search" . }}
  {{ if .Site.IsMultiLingual }}
    {{ partial "docs/languages" . }}
  {{ end }}

  {{ partial "docs/inject/menu-before" . }}
 
  <ul class="book-tree">
    {{ $page := .Page }}
    {{ $name := "" }}
    {{ $path := "" }}
    {{ $id := "" }}
    {{ $control := false }}

    <!-- list main sections -->
    {{ range site.Home.Pages }}
      {{ $level := 2 }}
      {{ $name = .LinkTitle | urlize | lower }}
      {{ $path = $name }}
      {{ $id = printf "ul%d-%s" $level $path }} 

      <!-- show collapsibles only in sections with children -->
      {{ $control = (gt (.Pages | len) 0) }}
      <li class="li-h{{ $level }} {{ if $control }}collapsible{{ end }}">
        <h{{ $level }}>{{ partial "docs/menu-anchor" (dict "page" $page "item" . "control" $control) }}</h{{ $level }}>
        <ul class="collapsible-target" id="{{ $id }}">
          {{ template "menu" (dict "page" $page "item" . "level" $level "path" $path) }}
        </ul>
      </li>
    {{ end }}

    <li class="li-h2 external-links">
      <h2>External</h2>
      {{ partial "docs/menu-hugo" .Site.Menus.external }}
    </li>
  </ulli-h{{ $level }}>

  {{ partial "docs/inject/menu-after" . }}
</nav>

<!-- Restore menu position as soon as possible to avoid flickering -->
{{ $script := resources.Get "menu-reset.js" | resources.Minify }}
{{ with $script.Content }}
  <script>{{ . | safeJS }}</script>
{{ end }}
